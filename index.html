<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FENC FAQ Chatbot</title>
    <link rel="stylesheet" href="static/style.css">
      <script>

        async function sendQuestion() {
          const userInput = document.getElementById("userInput").value.trim();
          insertUserMessage("user",userInput);//add users message to the container above the textbox
          document.getElementById("ai_and_user_container").style.display="block";
          document.getElementById("current_convo_container").style.justifyContent="flex-start";
          document.getElementById("main_container").style.gridTemplateRows="1fr auto";
          
          const res = await fetch("/ask", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ question: userInput })
          });
          const data = await res.json();
          console.log(data);
          
          if(data.response){
            formattedResponse = formatMarkdown(data.response);
          }
          else{
             insertUserMessage("ai_response_error",data.error);
          }

          insertUserMessage("ai_response",formattedResponse.trim());
        }

function escapeHtml(text) {
  return text
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

function formatMarkdown(text) {
  // 1) Sanitize, then convert bold/italic
  text = escapeHtml(text)
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/(^|[^*])\*(?!\s)([^*]+?)\*(?!\*)/g, '$1<em>$2</em>');

  const lines = text.split('\n');
  let html = '';
  const stack = [];           // tracks open <ul> levels
  const indentSize = 4;       // assumes 4 spaces = one nested level

  lines.forEach(raw => {
    const match = raw.match(/^(\s*)\* (.+)/);

    if (match) {
      const indent = match[1].length;
      const content = match[2].trim();
      const level = Math.floor(indent / indentSize);

      // 2) Close deeper lists if we backed up
      while (stack.length > level + 1) {
        html += '</li></ul>';
        stack.pop();
      }

      // 3) Open new nested lists if we went deeper
      while (stack.length < level + 1) {
        html += '<ul>';
        stack.push(true);
      }

      // 4) If we're still in the same list level, close previous <li>
      if (html.endsWith('</li>')) {
        html += '</li>';
      }

      // 5) Add this item
      html += `<li>${content}`;
    }
    else {
      // 6) close any open lists before dumping a paragraph
      while (stack.length) {
        html += '</li></ul>';
        stack.pop();
      }
      const trimmed = raw.trim();
      if (trimmed) html += `<p>${trimmed}</p>`;
    }
  });

  // 7) close any final open lists
  while (stack.length) {
    html += '</li></ul>';
    stack.pop();
  }

  return html;
}

        function insertUserMessage(userRole,messageText) {
          document.getElementById("welcome_message")?.remove();//removes welcome message if it exists
          if (messageText === "") return; // Avoid empty messages

          // Create the new div
          const userDiv = document.createElement("div");
          userDiv.className = userRole;
          if(userRole === "ai_response"){
            userDiv.innerHTML = messageText;
          }
          else{
            userDiv.textContent = messageText;
          }

          // Append to the conversation container
          const convoContainer = document.getElementById("ai_and_user_container");
          convoContainer.appendChild(userDiv);
          const scrollParent = document.getElementById("current_convo_container");
          scrollParent.scrollTop = scrollParent.scrollHeight;

        }
      
      </script>
</head>
<body>

    <div id="main_container">
        <div id="sidebar" class="unselectable">
            <p id="sidebar_heading" class="center">FENC Chatbot</p>

            <div id="new_chat_container"> <img src="static/images/icons8-edit-pencil.svg" alt="" width="20px"> New Chat</div>

            <div id="conversation_history_container">
                <p>Chats</p>
                <div class="side_panel"><img src="static/images/icons8-chat-room-96.svg" alt="" width="20px">Chat 1</div>
                <div class="side_panel"><img src="static/images/icons8-chat-room-96.svg" alt="" width="20px">Chat 2</div>
                <div class="side_panel"><img src="static/images/icons8-chat-room-96.svg" alt="" width="20px">Chat 3</div>
                <div class="side_panel"><img src="static/images/icons8-chat-room-96.svg" alt="" width="20px">Chat 4</div>
                <div class="side_panel"><img src="static/images/icons8-chat-room-96.svg" alt="" width="20px">Chat 5</div>
                <div class="side_panel"><img src="static/images/icons8-chat-room-96.svg" alt="" width="20px">Chat 6</div>
                <div class="side_panel"><img src="static/images/icons8-chat-room-96.svg" alt="" width="20px">Chat 7</div>
                                
            </div>
                
        </div>
        
        
        <div id="current_convo_container">
            <p id="welcome_message">What can I help with ?</p>
            <div id="ai_and_user_container">

            </div>
        </div>

        <div id="user_interaction_container">
            <div id="user_interaction_items">
                
                <div id="textarea_container">
                    <textarea id="userInput" placeholder="Type your question here..."  rows="1"></textarea>
                </div>

                <div id="options_container" class="unselectable" >
                    <img src="static/images/up_arrow.svg" alt="" width="25px" onclick="sendQuestion()">
                </div>

            </div>
        </div>


    </div>

    <script src="static/script.js"></script>
</body>
</html>